pipeline {
    agent any

    parameters {
        booleanParam(name: 'SKIP_DEPLOY', defaultValue: true, description: 'If true, skip deploy stage')
    }

    environment {
        VIRTUAL_ENV = 'venv'  // Define virtual environment name
    }

    stages {
        stage('Setup') {
            steps {
                script {
                    // Check if the virtual environment folder exists, if not, create it
                    if (!fileExists("${env.WORKSPACE}\\${VIRTUAL_ENV}")) {
                        bat "python -m venv ${VIRTUAL_ENV}"  // Create virtual environment
                    }
                    // Activate the virtual environment and install required packages from requirements.txt
                    bat "call ${VIRTUAL_ENV}\\Scripts\\activate && pip install -r jenkins_project\\requirements.txt"

                }
            }
        }

        stage('Lint') {
            steps {
                script {
                    // Run flake8 to lint the code
                    bat "call ${VIRTUAL_ENV}\\Scripts\\activate && flake8 jenkins_project\\app.py"
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    // Ensure we're in the correct working directory before running tests and produce JUnit XML for Jenkins
                    bat """
                        cd ${env.WORKSPACE}
                        call ${VIRTUAL_ENV}\\Scripts\\activate
                        set PYTHONPATH=%CD%\\jenkins_project
                        pytest jenkins_project\\tests\\test_app.py -v --tb=short --junitxml=jenkins_project\\tests\\report.xml
                    """
                    // Publish test results to Jenkins
                    junit 'jenkins_project/tests/report.xml'
                    // Archive the test report XML as a build artifact
                    archiveArtifacts artifacts: 'jenkins_project/tests/report.xml', fingerprint: true
                }
            }
        }

        stage('Coverage') {
            steps {
                script {
                    // Run coverage to track test coverage and produce XML/HTML
                    bat """
                        call ${VIRTUAL_ENV}\\Scripts\\activate
                        set PYTHONPATH=%CD%\\jenkins_project
                        coverage run -m pytest jenkins_project\\tests\\test_app.py
                        coverage xml -o jenkins_project\\coverage.xml
                        coverage html -d jenkins_project\\htmlcov
                    """
                    // Archive coverage artifacts so they are available from the build page
                    archiveArtifacts artifacts: 'jenkins_project/coverage.xml, jenkins_project/htmlcov/**', fingerprint: true
                }
            }
        }

        stage('Security Scan') {
            steps {
                script {
                    // Run bandit to check for security vulnerabilities
                    bat "call ${VIRTUAL_ENV}\\Scripts\\activate && bandit -r jenkins_project\\app.py"
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    echo "Deploying application..."
                    if (params.SKIP_DEPLOY.toBoolean()) {
                        echo "SKIP_DEPLOY is true — skipping deploy stage."
                    } else {
                        // only run deploy if the deploy script exists
                        if (fileExists("${env.WORKSPACE}\\deploy.bat")) {
                            bat "call ${env.WORKSPACE}\\deploy.bat"
                        } else {
                            error "deploy.bat not found and SKIP_DEPLOY is false — aborting deploy"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            // Clean up the workspace after each run to free resources
            cleanWs()
        }
    }
}
